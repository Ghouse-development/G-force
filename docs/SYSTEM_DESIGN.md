# G-force システム設計書

## 1. システム概要

### 1.1 目的
Gハウスの営業・営業事務・設計・工事部門の業務効率化を実現するWebアプリケーション

### 1.2 主要機能
1. 顧客管理（顧客マスタ）
2. 資金計画書（営業が商談中に作成）
3. 契約依頼（承認ワークフロー付き）
4. 請負契約書（営業事務が作成）
5. プラン依頼（設計への依頼 + 集計システム）
6. 引継書（営業→工事への引継ぎ）
7. マスタ管理（商品・キャンペーン・ユーザー）
8. ノーコード機能（フォーム・ワークフロー・画面の追加変更削除）

### 1.3 ユーザーロール
| ロール | 権限 |
|-------|------|
| 営業 | 顧客登録、資金計画書作成、契約依頼作成、プラン依頼作成、引継書作成 |
| 営業リーダー | 営業の権限 + 契約依頼承認（内容確認） |
| 営業事務 | 請負契約書作成、契約依頼閲覧 |
| 設計部門長 | 契約依頼承認（図面・金額確認）、プラン依頼管理 |
| 工事部門長 | 契約依頼承認（工期・運搬経路確認） |
| 設計 | プラン依頼対応、引継書閲覧 |
| CAD担当 | プラン依頼対応 |
| IC | 引継書閲覧 |
| 現場監督 | 引継書閲覧 |
| 外構担当 | 引継書閲覧 |
| 本部 | 全体閲覧、マスタ管理、業務フロー変更、ノーコード設定 |

---

## 2. ノーコード基盤設計

### 2.1 概念
システムの根幹をノーコードで構築可能にする。

```
┌─────────────────────────────────────────────────────────────┐
│                    ノーコード管理画面                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ フォーム定義  │ │ ワークフロー │ │  画面定義   │           │
│  │   ビルダー   │ │   ビルダー   │ │  ビルダー   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            ↓ 定義データ（JSON）
┌─────────────────────────────────────────────────────────────┐
│                     データベース                             │
│  form_definitions | workflow_definitions | page_definitions  │
│  field_definitions | workflow_steps | component_definitions  │
└─────────────────────────────────────────────────────────────┘
                            ↓ 動的レンダリング
┌─────────────────────────────────────────────────────────────┐
│                     アプリケーション                          │
│  DynamicForm | DynamicWorkflow | DynamicPage               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 フォームビルダー
フォームの項目を動的に追加・変更・削除できる。

**フィールドタイプ**:
- text（テキスト）
- number（数値）
- currency（金額）
- date（日付）
- select（選択）
- multiselect（複数選択）
- checkbox（チェックボックス）
- textarea（テキストエリア）
- file（ファイル）
- calculated（計算フィールド）
- reference（他テーブル参照）

**フィールド定義の例**:
```json
{
  "id": "customer_name",
  "type": "text",
  "label": "顧客名",
  "required": true,
  "validation": {
    "maxLength": 100
  },
  "layout": {
    "column": 1,
    "row": 1,
    "width": "half"
  }
}
```

### 2.3 ワークフロービルダー
承認フローを動的に定義できる。

**ワークフロー定義の例（契約依頼）**:
```json
{
  "id": "contract_request_workflow",
  "name": "契約依頼承認フロー",
  "steps": [
    {
      "id": "step_1",
      "name": "営業リーダー確認",
      "type": "approval",
      "assignee": { "role": "営業リーダー" },
      "actions": ["approve", "reject"],
      "next": { "approve": "step_2", "reject": "step_revision" }
    },
    {
      "id": "step_2",
      "name": "設計・工事部門長確認",
      "type": "parallel_approval",
      "assignees": [
        { "role": "設計部門長" },
        { "role": "工事部門長" }
      ],
      "require": "all",
      "actions": ["approve", "reject"],
      "next": { "approve": "step_complete", "reject": "step_revision" }
    },
    {
      "id": "step_revision",
      "name": "修正",
      "type": "revision",
      "assignee": { "role": "creator" },
      "next": { "submit": "step_1" }
    },
    {
      "id": "step_complete",
      "name": "完了",
      "type": "notify",
      "notify": [{ "role": "営業事務" }]
    }
  ]
}
```

### 2.4 画面ビルダー
画面のレイアウトとコンポーネントを定義できる。

**コンポーネントタイプ**:
- list（一覧表示）
- detail（詳細表示）
- form（フォーム）
- dashboard（ダッシュボード）
- chart（グラフ）
- kanban（カンバン）
- calendar（カレンダー）
- table（テーブル）

---

## 3. データベース設計

### 3.1 ER図（概念）

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   tenants    │────<│    users     │────<│  customers   │
└──────────────┘     └──────────────┘     └──────────────┘
                            │                    │
                            │                    │
                     ┌──────┴──────┐      ┌──────┴──────┐
                     │             │      │             │
              ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
              │ fund_plans   │  │contract_reqs │  │plan_requests │
              └──────────────┘  └──────────────┘  └──────────────┘
                                      │
                                      │
                               ┌──────────────┐
                               │  contracts   │
                               └──────────────┘
```

### 3.2 テーブル一覧

#### コアテーブル
| テーブル名 | 説明 |
|-----------|------|
| tenants | テナント（会社） |
| users | ユーザー |
| customers | 顧客 |
| fund_plans | 資金計画書 |
| contract_requests | 契約依頼 |
| contracts | 請負契約書 |
| plan_requests | プラン依頼 |
| handovers | 引継書 |

#### マスタテーブル
| テーブル名 | 説明 |
|-----------|------|
| products | 商品マスタ |
| campaigns | キャンペーンマスタ |
| banks | 銀行マスタ |

#### ノーコード基盤テーブル
| テーブル名 | 説明 |
|-----------|------|
| form_definitions | フォーム定義 |
| field_definitions | フィールド定義 |
| workflow_definitions | ワークフロー定義 |
| workflow_steps | ワークフローステップ |
| workflow_instances | ワークフロー実行インスタンス |
| page_definitions | 画面定義 |

#### ワークフロー・履歴
| テーブル名 | 説明 |
|-----------|------|
| approval_history | 承認履歴 |
| notifications | 通知 |
| activity_logs | 操作ログ |

---

## 4. 画面設計

### 4.1 画面一覧

#### 共通
- ログイン画面
- ダッシュボード

#### 顧客管理
- 顧客一覧
- 顧客詳細
- 顧客登録・編集

#### 資金計画書
- 資金計画書一覧
- 資金計画書作成・編集（Excel風）
- 資金計画書プレビュー（A3）
- PDF出力

#### 契約依頼
- 契約依頼一覧
- 契約依頼作成・編集
- 契約依頼詳細（承認フロー表示）
- 承認画面

#### 請負契約書
- 契約書一覧
- 契約書作成（契約依頼からデータ引継ぎ）
- 契約書プレビュー
- PDF出力

#### プラン依頼
- プラン依頼一覧
- プラン依頼作成
- プラン依頼詳細
- 集計ダッシュボード（件数・進捗・勝敗・統計）

#### 引継書
- 引継書一覧
- 引継書作成・編集
- 引継書詳細

#### マスタ管理
- 商品マスタ
- キャンペーンマスタ
- ユーザーマスタ

#### ノーコード管理（本部用）
- フォームビルダー
- ワークフロービルダー
- 画面ビルダー

---

## 5. 承認フロー設計

### 5.1 契約依頼の承認フロー

```
[営業] 作成
    ↓
[営業リーダー] 内容確認
  - 必要書類の漏れ
  - 資金計画の漏れ
  - スケジュールの間違い
  - お客様名の漏れ
  - キャンペーン情報の整合性
    ↓ 承認 / 差戻し
[設計部門長] + [工事部門長] ※並行
  設計: 図面確認・金額の漏れ
  工事: 工期の整合性・運搬経路
    ↓ 両方承認 / どちらか差戻し
[営業] 修正（差戻し時のみ）
    ↓ 再申請
[営業事務] 通知（全承認後）
    ↓
[営業事務] 請負契約書作成
```

### 5.2 プラン依頼のフロー

```
[営業] 作成
    ↓ 自動チェック（必要書類）
[設計] 受領・対応
    ↓
[設計] 完了報告
```

### 5.3 引継書のフロー

```
[営業] 作成
    ↓ 契約依頼の必須書類として紐付け
[設計/IC/現場監督/外構] 閲覧（契約後）
```

---

## 6. 外部連携設計（将来実装）

### 6.1 Formbridge連携
- Webhook受信でアンケート・ヒアリングデータを取得
- 顧客データに自動紐付け

### 6.2 kintone連携
- 顧客マスタの双方向同期
- APIトークン認証

### 6.3 スプレッドシート連携
- 来場予約・問い合わせ・資料請求のインポート
- Google Sheets API

---

## 7. 技術スタック

- **フロントエンド**: Next.js 15 (App Router), React 19, TypeScript
- **UI**: Tailwind CSS, shadcn/ui
- **状態管理**: Zustand
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth (開発中は開発用ログイン)
- **PDF生成**: jsPDF, html2canvas
- **フォーム**: React Hook Form, Zod

---

## 8. 実装フェーズ

### Phase 1: 基盤構築（最優先）
1. データベーススキーマ作成（SQL 1ファイル）
2. Supabaseクラウド保存有効化
3. ノーコード基盤の実装
4. 開発用ログイン常時有効化

### Phase 2: コア機能
1. 顧客管理
2. 資金計画書（A3対応）
3. 契約依頼・承認フロー
4. 請負契約書

### Phase 3: 追加機能
1. プラン依頼・集計システム
2. 引継書
3. マスタ管理

### Phase 4: 外部連携
1. Formbridge連携
2. kintone連携
3. スプレッドシート連携
